<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url("https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap");

        :root {
            --primary-color: #2a9d8f;
            --secondary-color: #e9e9e9;
            --background-color: #f8f8f8;
            --card-background: #e9e9e9;
            --text-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Roboto", sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
        }

        .mobile-container {
            width: 375px;
            height: 812px;
            background-color: var(--background-color);
            border-radius: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 10px;
        }

        .cart-header h1 {
            font-size: 24px;
            font-weight: 500;
        }

        .profile-icon {
            font-size: 40px;
            color: #555;
        }

        .cart-items {
            overflow-y: auto;
            max-height: 330px;
            /* Increased height to show ~3 items */
        }

        .cart-item {
            background-color: var(--card-background);
            border-radius: 20px;
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
        }

        .cart-item img {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            object-fit: cover;
            margin-right: 10px;
        }

        .item-details {
            flex-grow: 1;
        }

        .item-details p {
            margin: 1px 0;
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .item-details .item-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-color);
        }

        .payment-flow {
            margin: 20px 10px;
        }

        .total-section {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 15px;
        }

        .btn-pay {
            background-color: var(--primary-color);
            color: white;
        }

        .payment-label {
            font-size: 16px;
            font-weight: 500;
            color: #555;
            margin-bottom: 10px;
            margin-top: 20px;
        }

        .payment-select,
        .payment-info {
            width: 100%;
            background-color: #e9e9e9;
            border: none;
            border-radius: 15px;
            padding: 15px;
            font-size: 16px;
            margin-bottom: 15px;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
        }

        .payment-info {
            background-color: #d1e7e5;
            border: 2px solid var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .payment-info i {
            cursor: pointer;
        }

        .upload-area {
            position: relative;
            background-color: #e9e9e9;
            border-radius: 20px;
            height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #888;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .upload-area i {
            font-size: 30px;
            margin-bottom: 10px;
        }

        .btn-home {
            background-color: var(--secondary-color);
            color: #555;
            text-decoration: none;
            text-align: center;
            display: block;
        }

        .hidden {
            display: none;
        }

        #preview-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }
    </style>
</head>

<body>
    <div class="mobile-container">
        <header class="cart-header">
            <h1 id="cart-title">Cart</h1>
            <i class="fa-solid fa-user-circle profile-icon"></i>
        </header>

        <main class="cart-items" id="cart-items-container"></main>

        <section class="payment-flow">
            <div class="total-section">
                <span>Total:</span>
                <span id="total-price">0 Birr</span>
            </div>

            <div id="payment-details-section" class="hidden">
                <p class="payment-label">Select Payment Method</p>
                <select id="payment-method" class="payment-select">
                    <option value="">-- Loading Accounts --</option>
                </select>

                <div id="payment-info-box" class="payment-info hidden">
                    <span id="payment-account"></span>
                    <i class="fa-solid fa-copy"></i>
                </div>

                <input type="file" id="payment-proof-upload" class="hidden" accept="image/*">
                <label for="payment-proof-upload" class="upload-area">
                    <i class="fa-solid fa-image"></i>
                    <span>Upload Proof</span>
                    <img id="preview-image" class="hidden" src="#" alt="proof preview" />
                </label>
            </div>
            <button id="pay-btn" class="btn btn-pay">Pay</button>
            <a href="customer_home.html" class="btn btn-home">Back to Home</a>
        </section>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            const API_BASE_URL = 'http://127.0.0.1:8000';
            const cart = JSON.parse(localStorage.getItem('cart')) || [];
            const restaurantId = localStorage.getItem('restaurantId');

            if (cart.length === 0 || !restaurantId) {
                alert("Your cart is empty or the restaurant is not specified.");
                window.location.href = 'customer_home.html';
                return;
            }

            const cartItemsContainer = document.getElementById("cart-items-container");
            const cartTitle = document.getElementById("cart-title");
            const totalPriceEl = document.getElementById("total-price");
            const payBtn = document.getElementById("pay-btn");
            const paymentDetailsSection = document.getElementById("payment-details-section");
            const paymentMethodSelect = document.getElementById("payment-method");
            const paymentInfoBox = document.getElementById("payment-info-box");
            const paymentAccountEl = document.getElementById("payment-account");
            const paymentProofUpload = document.getElementById("payment-proof-upload");
            const previewImage = document.getElementById("preview-image");

            let paymentAccounts = [];

            async function fetchWithAuth(endpoint, options = {}) {
                const token = localStorage.getItem('accessToken');
                if (!token) {
                    window.location.href = 'customer_login.html';
                    return;
                }

                const headers = { 'Authorization': `Bearer ${token}`, ...options.headers };

                if (!(options.body instanceof FormData)) {
                    headers['Content-Type'] = 'application/json';
                }

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
                    if (response.status === 401) {
                        localStorage.removeItem('accessToken');
                        window.location.href = 'customer_login.html';
                        throw new Error('Unauthorized');
                    }
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(JSON.stringify(errorData));
                    }
                    const contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json();
                    } else {
                        return null;
                    }
                } catch (error) {
                    console.error('API Request Failed:', error);
                    if (error.message !== 'Unauthorized') {
                        alert('An API error occurred. Please try again.');
                    }
                    throw error;
                }
            }


            async function fetchPaymentAccounts() {
                try {
                    const accounts = await fetchWithAuth(`/api/payment-accounts/?restaurant=${restaurantId}`);
                    paymentAccounts = accounts;
                    paymentMethodSelect.innerHTML = '<option value="">-- Select --</option>';
                    if (accounts.length === 0) {
                        paymentMethodSelect.innerHTML = '<option value="">-- No accounts configured --</option>';
                    }
                    accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.id;
                        option.textContent = acc.account_type;
                        paymentMethodSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error("Could not fetch payment accounts:", error);
                    paymentMethodSelect.innerHTML = '<option value="">-- Error Loading --</option>';
                }
            }

            const updateCartDisplay = () => {
                cartItemsContainer.innerHTML = '';
                let total = 0;
                cart.forEach(item => {
                    total += parseFloat(item.price) * item.quantity;
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.innerHTML = `
                        <img src="${item.image || 'https://placehold.co/50x50/e9e9e9/333?text=Item'}" alt="${item.name}">
                        <div class="item-details">
                            <p class="item-name">${item.name}</p>
                            <p class="item-price">${item.quantity} x ${item.price} ETB</p>
                        </div>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                });
                totalPriceEl.textContent = `${total.toFixed(2)} Birr`;
                cartTitle.textContent = `${cart.length} item${cart.length !== 1 ? 's' : ''} in Cart`;
            };

            payBtn.addEventListener('click', async () => {
                if (payBtn.textContent === 'Pay') {
                    payBtn.textContent = "I Have Completed Payment";
                    paymentDetailsSection.classList.remove('hidden');
                    fetchPaymentAccounts();
                } else {
                    const proofFile = paymentProofUpload.files[0];
                    if (!proofFile) {
                        alert('Please upload a payment proof screenshot.');
                        return;
                    }

                    payBtn.disabled = true;
                    payBtn.textContent = 'Submitting...';

                    const formData = new FormData();
                    formData.append('restaurant', restaurantId);
                    formData.append('status', 'Pending Approval');
                    formData.append('payment_proof', proofFile);

                    const orderItems = cart.map(item => ({
                        menu_item_id: item.isAddon ? null : item.id,
                        addon_id: item.isAddon ? item.id : null,
                        quantity: item.quantity
                    }));
                    formData.append('items', JSON.stringify(orderItems));

                    try {
                        const newOrder = await fetchWithAuth('/api/orders/', {
                            method: 'POST',
                            body: formData,
                        });

                        localStorage.removeItem('cart');
                        localStorage.removeItem('restaurantId');
                        sessionStorage.setItem('lastOrder', JSON.stringify(newOrder));
                        window.location.href = 'under_review.html';
                    } catch (error) {
                        console.error("Failed to submit order:", error);
                        alert('There was an error submitting your order.');
                        payBtn.disabled = false;
                        payBtn.textContent = "I Have Completed Payment";
                    }
                }
            });

            paymentMethodSelect.addEventListener('change', () => {
                const selectedAccountId = paymentMethodSelect.value;
                const selectedAccount = paymentAccounts.find(acc => acc.id == selectedAccountId);
                if (selectedAccount) {
                    paymentAccountEl.textContent = selectedAccount.account_number;
                    paymentInfoBox.classList.remove('hidden');
                } else {
                    paymentInfoBox.classList.add('hidden');
                }
            });

            paymentInfoBox.querySelector('i').addEventListener('click', () => {
                const textToCopy = paymentAccountEl.textContent;
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('Account number copied!');
                } catch (err) {
                    alert('Failed to copy.');
                }
                document.body.removeChild(textArea);
            });

            paymentProofUpload.addEventListener('change', () => {
                const file = paymentProofUpload.files[0];
                if (file) {
                    previewImage.src = URL.createObjectURL(file);
                    previewImage.classList.remove('hidden');
                }
            });

            updateCartDisplay();
        });
    </script>
</body>

</html>